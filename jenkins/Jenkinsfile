pipeline {
    agent {
        docker {
            image '6242c31ed8b7acdd636a5ceeee0df75a85a680cd'
            args '''
              --user root
              --network=host
              -v /var/run/docker.sock:/var/run/docker.sock
              -v /home/lenovo/.kube:/home/lenovo/.kube
              -v /home/lenovo/.minikube:/home/lenovo/.minikube
            '''
        }
    }

    environment {
        IMAGE_NAME = "yourdockerhub/demo"
        IMAGE_TAG  = "${BUILD_NUMBER}"
        KUBECONFIG = "/home/lenovo/.kube/config"
    }

    stages {

        stage('Bind Docker to Minikube') {
            steps {
                sh '''
                  echo "=== Binding Docker to Minikube Docker Daemon ==="
                  eval $(minikube docker-env)
                  docker info | grep -i name
                '''
            }
        }

        stage('Precheck') {
            steps {
                sh '''
                  echo "=== Docker Version ==="
                  docker --version

                  echo "=== Kubectl Version ==="
                  kubectl version --client

                  echo "=== Cluster Status ==="
                  kubectl get nodes
                '''
            }
        }


stage('Deploy Monitoring (Prometheus & Grafana)') {
    steps {
        sh '''
          echo "=== Deploying Monitoring Stack ==="
          kubectl apply -f monitoring/
        '''
    }
}

        stage('Build Docker Image') {
            steps {
                sh '''
                  echo "=== Building Docker Image ==="
                  docker build -t ${IMAGE_NAME}:${IMAGE_TAG} app/
                '''
            }
        }

        stage('Security Scan (Trivy)') {
            steps {
                sh '''
                  echo "=== Running Trivy Scan ==="
                  trivy image --severity HIGH,CRITICAL --exit-code 1 ${IMAGE_NAME}:${IMAGE_TAG}
                '''
            }
        }

        stage('Deploy to Minikube') {
            steps {
                sh '''
                  echo "=== Updating image tag in deployment ==="
                  sed -i "s|image: yourdockerhub/demo:.*|image: ${IMAGE_NAME}:${IMAGE_TAG}|" k8s/deployment.yaml

                  echo "=== Applying Kubernetes manifests ==="
                  kubectl apply -f k8s/

                  echo "=== Waiting for rollout ==="
                  kubectl rollout status deployment/ranga-app --timeout=120s
                '''
            }
        }
    }

    post {
        success {
            echo "‚úÖ Deployment successful!"
        }

        failure {
            echo "‚ùå Pipeline failed. Rolling back..."
            sh '''
              kubectl get deployment ranga-app && \
              kubectl rollout undo deployment/ranga-app || true
            '''
        }

        always {
            echo "üì¶ Build Number: ${BUILD_NUMBER}"
            echo "üñºÔ∏è Image Used: ${IMAGE_NAME}:${IMAGE_TAG}"
        }
    }
}
