pipeline {
    agent {
        docker {
            image '6242c31ed8b7acdd636a5ceeee0df75a85a680cd'
            args '''
              --network=host
              -v /var/run/docker.sock:/var/run/docker.sock
              -v $HOME/.kube:/home/jenkins/.kube
              -v $HOME/.minikube:/home/jenkins/.minikube
            '''
        }
    }

    environment {
        IMAGE_NAME = "yourdockerhub/demo"
        IMAGE_TAG  = "${BUILD_NUMBER}"
    }

    stages {

        stage('Precheck') {
            steps {
                sh '''
                  docker --version
                  kubectl version --client
                  kubectl get nodes
                '''
            }
        }

        stage('Build Docker Image') {
            steps {
                sh 'docker build -t $IMAGE_NAME:$IMAGE_TAG app/'
            }
        }

        stage('Security Scan (Trivy)') {
            steps {
                sh 'trivy image $IMAGE_NAME:$IMAGE_TAG'
            }
        }

        stage('Deploy to Minikube') {
            steps {
                sh '''
                  kubectl apply -f k8s/
                  kubectl rollout status deployment/ranga-app
                '''
            }
        }
    }

    post {
        failure {
            echo "‚ùå Pipeline failed. Rolling back..."
            sh 'kubectl rollout undo deployment/ranga-app || true'
        }
    }
}
